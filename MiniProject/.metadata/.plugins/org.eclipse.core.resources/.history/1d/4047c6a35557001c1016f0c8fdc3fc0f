import java.awt.*;
import java.awt.event.*;
import javax.swing.*;

public class GamePanel extends JPanel{ 
	private GameThread gameTh = null;
	private Thread textTh [] = null; // text 움직이기 위해 만든 thread
	private Thread diamondTh = null;
	private Thread itemTh [] = new ItemThread[3];
	
	private JTextField input = new JTextField(40);
	private JLabel text [] = new JLabel[10];
	private int textChange[] = new int [10]; // text 맞히는 횟수(text 변화 횟수)
	private JLabel diamond = null;  // 다이아몬드
	private int diamondCount = 0;
	private JLabel item[] = new JLabel [3]; // item
	private int itemCount[] = new int [3];
	
	private int textCount = 0;
	private int maxTextCount = 4; // 화면에 표시할 수 있는 최대 카운트
	private int delay = 600;
	private int gameStart = 0; // game이 진행되는지 알기 위해 사용 (0:진행 X || 1:진행 O)
	
	ImageIcon level1Icon = new ImageIcon("level1-1.png");
	ImageIcon diamondIcon = new ImageIcon("diamond.png");
	ImageIcon [] level2Icon = {
			new ImageIcon("level2-1.png"), 
			new ImageIcon("level2-2.png"),
	};
	ImageIcon [] itemIcon = {
			new ImageIcon("bread.png"), 
			new ImageIcon("bomb.png"), 
			new ImageIcon("pickax.png")
	};
	
	private ScorePanel scorePanel = null;
	private EditPanel editPanel = null;
	private GameGroundPanel groundPanel = null;
	private GameInitPanel startPanel = null;
	private GameFrame gameFrame = null;
	
	public GamePanel(ScorePanel scorePanel, EditPanel editPanel, GameGroundPanel groundPanel,Thread[] textTh, GameFrame gameFrame) {
		this.scorePanel = scorePanel;
		this.editPanel = editPanel;
		this.groundPanel = groundPanel;
		this.textTh = textTh;
		this.gameFrame = gameFrame;
		
		startPanel = new GameInitPanel(0,"보석을 찾아 부자가 될거야!");
		
		gameStart = 0; // 게임 초기화 (시작 전 단계) -> 1이 되면 게임 시작된 것(게임 중복 시작 방지)
		
		level1Icon = imgSizeSet(level1Icon);
		diamondIcon = imgSizeSet(diamondIcon);
		for(int i=0;i<2;i++)
			level2Icon[i] = imgSizeSet(level2Icon[i]);
		for(int i=0;i<3;i++)
			itemIcon[i] = imgSizeSet(itemIcon[i]);
		
		setLayout(new BorderLayout());
		add(startPanel,BorderLayout.CENTER);
		add(new InputPanel(),BorderLayout.SOUTH);
		input.addActionListener(new ActionListener() {
			@Override
			public void actionPerformed(ActionEvent e) {
				JTextField t = (JTextField)e.getSource(); // e를 실행한 객체 알아내기
				String inWord = t.getText();
				if(inWord.equals("play") && gameStart == 0) { // play라고 입력시 게임 시작
					gameFrame.startGameTh();
				}
				
				if(inWord.equals("!") && scorePanel.getBombCount()>0) {
					scorePanel.bombDecrease();
					((GameThread) gameTh).allEnd(); // 실행중인 Thread 모두 제거			
				}
				
				if(diamondCount != 0)
					if(diamond.getText().equals(inWord)) { // diamond를 맞췄을 경우
						diamondCount--;
						textMoveThreadEnd(); // 실행중인 textMoveThread 제거
						itemThreadEnd();
						((DiamondThread) diamondTh).getTedScore();
					}
				
				for(int i=0;i<3;i++) {
					if(itemCount[i]!=0) {
						if(item[i].getText().equals(inWord)) { // 맞추기 성공(정답)
							switch(i) {
							// 0 = 빵item(생명++) | 1 = 폭탄 item(보석 모두 삭제) | 2 = 곡괭이item(속도 낮추기)
							case 0: scorePanel.lifeiIncrease(); break;
							case 1: scorePanel.bombIncrease(); break;
							case 2: ((GameThread) gameTh).setTextSpeed(2); break;
							}
							itemCount[i]--;
							itemTh[i].interrupt();
						}
					}
				}
				
				for(int i=0;i<maxTextCount;i++) { // 화면에 있는 text를 모두 검사하기 위해 0~textCount-1까지 모두 비교
					if(textChange[i] != 0) {
						if(text[i].getText().equals(inWord)) { // 맞추기 성공(정답)
							textChange[i]--; // 맞췄으니 1 감소
							if(textChange[i]<=0) {
								Icon icon = text[i].getIcon();
								if(icon.equals(level2Icon[0]) || icon.equals(level2Icon[1])) // level 2일경우 true
									scorePanel.increase(20); // 점수 올리기 (20점)
								else
									scorePanel.increase(10); // 점수 올리기 (10점)
								textTh[i].interrupt(); // textTh[i]스레드에게 InterruptedException을 보내는 함수. 중단 시키고 싶어
							}
							else
								groundPanel.addNewWord(text[i]); // 새로운 단어 출력
						}
					}
				}
				t.setText(""); // input 창 지우기
			}
		});
	}
	public void setGameThread(GameThread gameTh) { this.gameTh = gameTh; }  // gameThread 설정
	public void decreaseDiamond() { diamondCount--; }
	public int getTextChange(int i) { return textChange[i]; }
	// textChange 확인	
	public void setTextChange(int i, int n) { this.textChange[i] = n; }
	// textChange 설정
	public void textCountDecrease() { this.textCount--; }
	// textCount 감소
	public JTextField getInput() { return input; }
	// input 리턴 (input에 focus를 맞추기 위해 존재)
	public int getGameStart() { return gameStart; }
	public void setGame(int delay, int maxTextCount) {
		this.delay = delay;
		this.maxTextCount = maxTextCount;
	}
	public void startGamePanel(){
		add(groundPanel,BorderLayout.CENTER);
		startPanel.setVisible(false);
		groundPanel.setVisible(true);
		gameStart = 1;
	}
	public void gameEndPanel(int i) {
		String s = (i==1)?"GAME CLEAR":"GAME OVER";
		
		startPanel = new GameInitPanel(i,s);
		add(startPanel,BorderLayout.CENTER);
		groundPanel.setVisible(false);
		gameStart = 0;
	}
	public ImageIcon imgSizeSet(ImageIcon icon) {
		Image img = icon.getImage();
		Image changeImg = img.getScaledInstance(20,20,Image.SCALE_SMOOTH);
		ImageIcon changeIcon = new ImageIcon(changeImg);
		return changeIcon;
	}
	public void delaySet(double n,String s) { 
		delay = (int)(delay*n);	
		scorePanel.changeSpeed(s);
		}
	public void textMake(int i) {
		int randomFrequency = (int)(Math.random()*99)+1; // 보석이 출현하는 빈도수 결정
		
		if(randomFrequency >= 90 && diamondCount==0) { // 10%는 다이아몬드 출현 && diamond는 한번에 하나만 출현 가능
			diamondCount++;
			diamond = new JLabel("",diamondIcon,JLabel.CENTER);
			groundPanel.textAdd(diamond);
			
			diamondTh = new DiamondThread(diamond, scorePanel, this, (int)(delay/2));
			diamondTh.start(); // 스레드 시작
		}
		else if(randomFrequency >= 75) { // 15%는 아이템 출현
			// 0 = 빵item(생명++) | 1 = 폭탄 item(보석 모두 삭제) | 2 = 곡괭이item(속도 낮추기)
			int randomitem = (int)(Math.random()*3); // item 선정(어떤 아이템인가)
			if(scorePanel.checkLifeCount() && randomitem == 0) // 빵 아이템은 목숨이 최대일때 안나오게 만듦
				randomitem =(int)(Math.random()*2)+1;
			if(itemCount[randomitem] == 0) { // 한 item은 화면에 하나만 나올 수 있음(화면에 item이 존재하는지 확인)
				item[randomitem] = new JLabel("",itemIcon[randomitem], JLabel.CENTER);
				groundPanel.textAdd(item[randomitem]);
				itemCount[randomitem]++;
				
				itemTh[randomitem] = new ItemThread(item[randomitem], delay);
				itemTh[randomitem].start(); // 스레드 시작
			}
		}
		else {
			if(randomFrequency >= 20) {  // 55%는 1번 입력하면 획득할 수 있는 보석
				textChange[i] = 1; 
				text[i] = new JLabel("",level1Icon,JLabel.CENTER);
			}
			else  { // 20%는 2번 입력하면 획득할 수 있는 보석
				textChange[i] = 2;
				text[i] = new JLabel("",level2Icon[(int)(Math.random()*2)],JLabel.CENTER);
			}
			groundPanel.textAdd(text[i]);
			textCount++; // text가 생성되었으므로 count증가
		
			textTh[i] = new TextMoveThread(text[i], scorePanel, this, i, delay); // 스레드 생성
			textTh[i].start(); // 스레드 시작(JVM에게 스케줄링해도 됩니다)
		}
	}
	public void textMoveThreadEnd () {
		for(int i=0;i<maxTextCount;i++) { // 현재 실행 중인 textTh 중지
			if(getTextChange(i) != 0) { 
				textChange[i] = 0; 
				textTh[i].interrupt(); // 현재 존재하는 text 스레드 중지
			}
		}
	}
	public void itemThreadEnd() {
		for(int i=0;i<3;i++) { // 현재 실행 중인 textTh 중지
			if(itemCount[i] != 0) { 
				itemCount[i] = 0; 
				itemTh[i].interrupt(); // 현재 존재하는 text 스레드 중지
			}
		}
	}
	public void diamondThreadEnd() {
		if(diamondCount != 0) {
			diamondCount = 0;
			diamondTh.interrupt();
		}
	}
	
	class InputPanel extends JPanel {
		public InputPanel() {
			setLayout(new FlowLayout());
			setBackground(Color.lightGray);
			add(input);
		}
	}
	class GameInitPanel extends JPanel {
		private ImageIcon [] icon = {
				new ImageIcon("game.png"),
				new ImageIcon("success.png"),
				new ImageIcon("fail.png"),
		};
		private Image img = null;
		private Font font = new Font("타이포_쌍문동 B", Font.BOLD, 30);
		
		private JLabel initText = new JLabel("");
		
		public GameInitPanel(int select, String s) {
			img = icon[select].getImage();
			initText.setText(s);
			setLayout(new BorderLayout());
			initGame(); // 초기 화면 설정
		}
		public void initGame() { // 초기화면
			initText.setHorizontalAlignment(JLabel.CENTER);
			initText.setFont(font);
			initText.setForeground(Color.WHITE);
			add(initText);
		}
		@Override
		public void paintComponent(Graphics g) { //call back 함수
			super.paintComponent(g); // 중요 - 패널을 모두 지운다 -> 배경색을 칠한다
			g.drawImage(img, 0,0, this.getWidth(), this.getHeight(), null);
		}
	}
}
